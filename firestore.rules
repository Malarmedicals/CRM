rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------------
    // Helper Functions
    // -----------------------------
    function isAuthenticated() {
      return request.auth != null;
    }

    // Checks whether requester exists in users collection and has role 'admin' or 'manager'
    function isAdminOrManager() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
          in ['admin', 'manager'];
    }

    // Defensive check to avoid exposing sensitive user fields to non-admin users.
    function isSafePublicUserData() {
      return resource != null &&
        !(('role' in resource.data) ||
          ('phone' in resource.data) ||
          ('address' in resource.data) ||
          ('permissions' in resource.data));
    }

    // -----------------------------
    // Users Collection
    // -----------------------------
    match /users/{userId} {
      /*
       * READ:
       *  - owner: full read
       *  - admin/manager: full read
       *  - other authenticated users: only if the document contains no sensitive fields (defensive)
       */
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isAdminOrManager() ||
        isSafePublicUserData()
      );

      // Create: allow user to create their own profile document
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Update/Delete: only admin/manager
      allow update, delete: if isAdminOrManager();
    }

    // Allow listing users for authenticated clients (server-side rules still enforce per-doc reads)
    match /users {
      allow list: if isAuthenticated();
    }

    // -----------------------------
    // Orders Collection
    // -----------------------------
    // -----------------------------
    // Orders Collection
    // -----------------------------
    match /orders/{orderId} {
      // Read: owner or admin/manager
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid || isAdminOrManager());

      // Create: Allow Public for Storefront Demo (Guest Checkout)
      allow create: if true;

      // Update: admin/manager can update anything; owner can set status to 'cancelled' (example)
      allow update: if isAdminOrManager() ||
                    (isAuthenticated() &&
                     resource.data.userId == request.auth.uid &&
                     request.resource.data.status == 'cancelled');

      // Delete: admin/manager only
      allow delete: if isAdminOrManager();
    }

    // -----------------------------
    // Products Collection
    // -----------------------------
    match /products/{productId} {
      // Public read for e-commerce storefront
      allow read: if true;

      // Create/Update/Delete: admin/manager only
      allow create, update, delete: if isAdminOrManager();
    }

    // -----------------------------
    // Banners Collection
    // -----------------------------
    match /banners/{bannerId} {
      allow read: if true;
      allow create, update, delete: if isAdminOrManager();
    }

    // -----------------------------
    // Categories Collection
    // -----------------------------
    match /categories/{categoryId} {
      allow read: if true;
      allow create, update, delete: if isAdminOrManager();
    }

    // -----------------------------
    // Leads Collection
    // -----------------------------
    match /leads/{leadId} {
      // Public forms may create leads
      allow create: if true;

      // Read/Update/Delete: admin/manager only
      allow read, update, delete: if isAdminOrManager();
    }

    // -----------------------------
    // CRM Actions Collection
    // -----------------------------
    match /crmActions/{actionId} {
      allow read, write: if isAdminOrManager();
    }

    // -----------------------------
    // Email Templates & Queue
    // -----------------------------
    match /emailTemplates/{templateId} {
      allow read, write: if isAdminOrManager();
    }

    match /emailQueue/{emailId} {
      allow read, write: if isAdminOrManager();
    }

    // -----------------------------
    // WhatsApp Templates & Queue
    // -----------------------------
    match /whatsappTemplates/{templateId} {
      allow read, write: if isAdminOrManager();
    }

    match /whatsappQueue/{messageId} {
      allow read, write: if isAdminOrManager();
    }

    // -----------------------------
    // Prescriptions Collection
    // -----------------------------
    match /prescriptions/{prescriptionId} {
      allow read: if isAuthenticated() && 
                  (resource.data.userId == request.auth.uid || isAdminOrManager());
      allow create: if true;
      allow update, delete: if isAdminOrManager();
    }

    // -----------------------------
    // Notifications Collection
    // -----------------------------
    match /notifications/{notificationId} {
      // Read: recipients or admin/manager
      allow read: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid || isAdminOrManager());

      // Create: Allow Public for Storefront Demo (Triggers)
      allow create: if true;

      // Update/Delete: admin/manager only
      allow update, delete: if isAdminOrManager();
    }

    // -----------------------------
    // Calendar Events (development)
    // -----------------------------
    match /events/{eventId} {
      // Development: open read/write. For production, change to:
      // allow read: if true; allow create/update/delete: if isAdminOrManager();
      allow read, write: if true;
    }

    // -----------------------------
    // Stock Movements
    // -----------------------------
    match /stockMovements/{movementId} {
      allow read, create, update, delete: if isAdminOrManager();
    }

    // -----------------------------
    // Fallback: deny everything else by default
    // -----------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
