rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() { return request.auth != null; }
    function isAdminOrManager() {
      return request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'manager'];
    }

    // -----------------------------
    // E-Commerce Notifications (Frontend)
    // -----------------------------
    match /eCommerceNotifications/{notificationId} {
      // Allow authenticated users to list/query notifications (for subscriptions)
      allow list: if isAuthenticated();
      
      // Allow reading specific notification if you are the owner or admin
      allow get: if isAuthenticated() && (
        resource == null ||
        resource.data.userId == request.auth.uid || 
        !('userId' in resource.data) ||
        isAdminOrManager()
      );
      
      // Allow creating notifications
      allow create: if isAuthenticated(); 
      
      // Allow marking as read (only isRead field)
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        !('userId' in resource.data) ||
        isAdminOrManager()
      );
      
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        isAdminOrManager()
      );
    }

    // -----------------------------
    // User Notifications (CRM/Admin)
    // -----------------------------
    match /user_notifications/{notificationId} {
      // Allow reading if you are the owner (check both userId and metadata.userId)
      allow read: if isAuthenticated() && (
        resource == null ||
        resource.data.userId == request.auth.uid || 
        resource.data.metadata.userId == request.auth.uid || 
        isAdminOrManager()
      );
      
      // Allow creating notifications (triggered by CRM)
      allow create: if isAuthenticated(); 
      
      // Allow marking as read
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        resource.data.metadata.userId == request.auth.uid || 
        isAdminOrManager()
      );
      
      allow delete: if isAdminOrManager();
    }

    // -----------------------------
    // Legacy Notifications (Admin/CRM)
    // -----------------------------
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        resource.data.metadata.userId == request.auth.uid || 
        isAdminOrManager()
      );
      allow create: if true;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || 
        resource.data.metadata.userId == request.auth.uid || 
        isAdminOrManager()
      );
    }

    // -----------------------------
    // Standard Collections
    // -----------------------------
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdminOrManager());
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update, delete: if isAdminOrManager();
      allow list: if isAuthenticated();
    }

    match /prescriptions/{prescriptionId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdminOrManager());
      allow create: if true;
      allow update, delete: if isAdminOrManager();
    }

    match /orders/{orderId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdminOrManager());
      allow create: if true;
      allow update: if isAdminOrManager() || (isAuthenticated() && resource.data.userId == request.auth.uid);
    }
    
    match /products/{productId} { 
      allow read: if true; 
      allow create, delete: if isAdminOrManager();
      // Allow authenticated users to update only stock-related fields
      allow update: if isAdminOrManager() || (
        isAuthenticated() && 
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['stockQuantity', 'stock', 'stockStatus', 'updatedAt'])
      );
    }
    
    match /categories/{categoryId} { allow read: if true; allow write: if isAdminOrManager(); }
    
    // -----------------------------
    // Health Concerns Collection
    // -----------------------------
    match /healthConcerns/{concernId} {
       allow read: if true;
       allow create, update, delete: if isAdminOrManager();
    }

    match /banners/{bannerId} { allow read: if true; allow write: if isAdminOrManager(); }
    match /leads/{leadId} { allow create: if true; allow read, update, delete: if isAdminOrManager(); }

    match /crmActions/{actionId} { allow read, write: if isAdminOrManager(); }
    match /emailTemplates/{templateId} { allow read, write: if isAdminOrManager(); }
    match /emailQueue/{emailId} { allow read, write: if isAdminOrManager(); }
    match /whatsappTemplates/{templateId} { allow read, write: if isAdminOrManager(); }
    match /whatsappQueue/{messageId} { allow read, write: if isAdminOrManager(); }
    match /stockMovements/{movementId} { allow read, write: if isAdminOrManager(); }
    match /events/{eventId} { allow read, write: if true; }
    match /{document=**} { allow read, write: if false; }
  }
}
